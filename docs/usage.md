# Usage 

```
wget git.io/mwscan.txt
grep -Erlf mwscan.txt /var/www
```

# Advanced scan for sysadmins

For faster scanning and more features, you can install the scanner from this repository.

## Using Debian/Ubuntu

```bash
# Install prerequisites on Debian/Ubuntu flavoured server
sudo apt install -qy python-pip gcc python-dev
sudo pip install --no-cache-dir --upgrade mwscan
``` 

## Using CentOS

```bash
# If you don't have EPEL yet, for CentOS 6:
wget https://dl.fedoraproject.org/pub/epel/epel-release-latest-6.noarch.rpm
sudo rpm -ivh epel-release-latest-6.noarch.rpm

sudo yum -y install python-pip python-devel gcc
sudo pip install --no-cache-dir --upgrade mwscan 
```

## Using Mac OSX

```bash
# Install prerequisites on a Mac OSX environemnt
brew install yara python
sudo pip install --no-cache-dir --upgrade mwscan
```

## Alternatively

If pip does not work for you, you can download the scanner and the rules file manually:

```bash
curl -s https://raw.githubusercontent.com/gwillem/magento-malware-scanner/master/mwscan/mwscan.py -o mwscan
curl -s https://raw.githubusercontent.com/gwillem/magento-malware-scanner/master/build/all-confirmed.yar -o rules.yar
chmod 755 mwscan
./mwscan --rules rules.yar /Users/frosit/Werk/Security/
```

## Run manually

If you have installed through pip, you can now run this and any hits will appear
```bash
mwscan /Users/frosit/Werk/Security/mage17

# this will for example show:
eval_post /Users/frosit/Werk/Security/mage17/media/dhl/info.php
obfuscated_eval /Users/frosit/Werk/Security/mage17/skin/backdoor1.php
```

## Running from cron

It is recommended to run nightly from cron. This will download the latest rules every night, run a scan on your Magento store and mail you if anything was found. 


```
cat <<EOM | sudo tee /etc/cron.d/mwscan

MAILTO=youremail@etc

RULESURL=https://raw.githubusercontent.com/gwillem/magento-malware-scanner/master/build/all-confirmed.yar
RULEFILE=/var/cache/rules.yar
MAGENTO=/var/www/magento
MWSCAN=/usr/bin/mwscan


10 2 * * * root /usr/bin/curl -s $RULES -o $RULESFILE && $MWSCAN --quiet --newonly --rules $RULESFILE $MAGENTO

EOM

```

## Advanced cron

This cron will ensure only a single concurrent scan, will log timestamped new finds to /var/log/mwscan.log and mail them to the supplied address. Requires `util-linux`, `moreutils` and `mailutils` on Ubuntu/Debian for `flock`, `ifne`, `ts`, and `mail`.

```
MAILTO=your@address
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

0 2 * * * root flock -n ~/.mwscan.lock mwscan --newonly --quiet /data/web | ts | tee -a /var/log/mwscan.log | ifne mail -s "Malware found at $(hostname)" -a 'From: Malware Scanner <noreply@yoursite.com>' $MAILTO
```
