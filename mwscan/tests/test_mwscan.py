import os
import time
from unittest import TestCase
from mwscan import scan, settings
from mwscan.ruleset import Files
from collections import namedtuple



class TestWebMalwareScanner(TestCase):

    def _load_file_rules(self, path):
        args = namedtuple('Args', 'rules')(rules=path)
        return Files(args=args).get()


    def setUp(self):


        settings.CACHEDIR = '/tmp'
        settings.LAST_RUN_FILE = '/tmp/last_run'

        self.fixture_path = os.path.join(os.path.dirname(os.path.realpath(__file__)), 'fixtures')
        self.rules_path = os.path.join(self.fixture_path, 'rules.yar')
        self.target_path = os.path.join(self.fixture_path, 'files')
        self.state_file = scan.scanpath_to_runfile(self.target_path)
        self.new_file = os.path.join(self.target_path, 'newer_malware')

        assert self.state_file.startswith('/tmp')

        # might still exist from cancelled earlier test
        for i in self.new_file, self.state_file:
            try:
                os.unlink(i)
            except OSError:
                pass

        self.rules, self.whitelist = self._load_file_rules(self.rules_path)


    def test_normal_scan(self):
        files = scan.find_targets(self.target_path)
        malware, whitelisted = scan.scan_files(files, self.rules, self.whitelist)

        self.assertEqual(len(malware), 2)
        self.assertEqual(len(whitelisted), 1)

    def test_newonly_scan(self):
        infections = set([self.new_file])

        scan.write_last_run_results(self.target_path, infections)
        infections.add('/newly/infected')

        new = scan.filter_new_infections(self.target_path, infections)

        self.assertEqual(len(new), 1)

    def test_filter_extensions(self):

        ext = ['php']

        files = scan.find_targets(self.target_path, req_ext=ext)
        malware, whitelisted = scan.scan_files(files, self.rules, self.whitelist)

        self.assertEqual(len(malware), 1)
        self.assertEqual(len(whitelisted), 0)

    def test_external_rule_file(self):
        files = scan.find_targets(self.target_path)

        rules_path = os.path.join(self.fixture_path, 'rules-vanilla.yar')
        self.rules, self.whitelist = self._load_file_rules(rules_path)

        malware, whitelisted = scan.scan_files(files, self.rules, self.whitelist)

        self.assertEqual(len(malware), 2)
        self.assertEqual(len(whitelisted), 0)

    def test_scan_targets_for_new_files_only(self):
        
        the_past = time.time() - 5

        with open(self.new_file, 'w') as fh:
            fh.write('BAD\n')
        
        files = scan.find_targets(self.target_path, newer_than=the_past)

        self.assertEqual(len(list(files)), 1)

        os.unlink(self.new_file)

        